# Causal World Model (CWM) State Specification

This document defines the multi-layer Causal World Model schema, lifecycle, and implementation guidelines.

---

## 1. Overview

Project LOGOS employs a multi-layer Causal World Model (CWM) to reason about the world. These layers are distinct in their abstraction level and source of truth but share a common structural envelope for interoperability.

| Layer | Name | Purpose | Storage |
|-------|------|---------|---------|
| **CWM-A** | Abstract | Symbolic entities, concepts, causal rules. Source of truth for planning. | Neo4j + Milvus |
| **CWM-G** | Grounded | Sensor data, predicted states, physics properties. Anchors symbols to reality. | Ephemeral → Neo4j |
| **CWM-E** | Emotional | Diary entries, emotional tags, reflections. Provides sense of self. | Neo4j (Persona) |

All three layers emit states wrapped in a unified `CWMState` envelope, ensuring downstream consumers (Apollo, loggers, debuggers) can visualize and process them uniformly.

---

## 2. Unified Envelope: `CWMState`

Every state emission from Sophia conforms to this envelope:

```json
{
  "state_id": "uuid-v4",
  "model_type": "cwm-a" | "cwm-g" | "cwm-e",
  "timestamp": "ISO-8601",
  "status": "hypothetical" | "observed" | "validated" | "rejected",
  "confidence": 0.0 - 1.0,
  "source": "planner" | "jepa" | "perception" | "reflection",
  "links": [
    { "rel": "derived_from", "target_id": "uuid-of-parent-state" },
    { "rel": "predicts", "target_id": "uuid-of-future-state" }
  ],
  "data": { /* Model-specific payload */ }
}
```

### Status Lifecycle

| Status | Meaning |
|--------|---------|
| `hypothetical` | Generated by planner/simulator. Not yet verified against reality. |
| `observed` | Directly perceived from sensors (CWM-G). |
| `validated` | Confirmed by SHACL constraints or consensus (promoted to CWM-A). |
| `rejected` | Falsified by observation or validation failure. |

---

## 3. Schemas by Model Type

### 3.1 CWM-A (Abstract)

**Focus**: Symbolic reasoning, planning, ontology.

**Key Node Types**:
- `Entity`: Physical objects or agents
- `Concept`: Abstract categories (e.g., `Cup`, `Grasp`)
- `State`: Snapshots of entity properties at a time
- `Process`: Causal transitions (`State A -[CAUSES]-> State B`)

**Example Payload**:
```json
{
  "concept_id": "uuid-concept-container",
  "name": "Container",
  "definition": "Object capable of holding other objects",
  "affordances": ["containment", "support"],
  "relations": [{ "type": "IS_A", "target": "PhysicalObject" }]
}
```

### 3.2 CWM-G (Grounded)

**Focus**: Perception, simulation, physics grounding.

**Key Node Types**:
- `PerceptionFrame`: Raw input from Talos (sensors) or Hermes (uploads)
- `ImaginedState`: Predicted future state from JEPA/Simulator
- `ImaginedProcess`: Action applied to reach an imagined state

**Example Payload**:
```json
{
  "frame_id": "uuid",
  "modality": "vision",
  "blob_ref": "s3://bucket/frame_123.jpg",
  "embedding": [0.1, 0.5, ...],
  "physics_props": { "mass": 1.2, "friction": 0.5 }
}
```

### 3.3 CWM-E (Emotional)

**Focus**: Reflection, persona, confidence.

**Key Node Types**:
- `PersonaEntry`: Diary entry or narrative summary
- `EmotionState`: Affective tags attached to other nodes

**Example Payload**:
```json
{
  "sentiment": "cautious",
  "intensity": 0.8,
  "summary": "I am unsure if the grip is stable.",
  "context_ref": "uuid-of-process-being-reflected-on"
}
```

---

## 4. Ingestion and Promotion Flows

### 4.1 Perception Loop (CWM-G → CWM-A)

```
Talos/Hermes → Raw Data → Sophia wraps as CWMState (CWM-G, observed)
    → JEPA encodes to embeddings
    → Match against CWM-A Concepts in Milvus
    → If high confidence: create/update State in CWM-A (validated)
```

### 4.2 Imagination Loop (CWM-A → CWM-G → CWM-A)

```
Planner proposes action → CWM-A (hypothetical)
    → Sophia calls simulate()
    → JEPA returns ImaginedState → CWM-G (hypothetical)
    → SHACL validates constraints
    → If valid: approve plan for execution
```

### 4.3 Reflection Loop (CWM-A/G → CWM-E)

```
Inner Monologue monitors event stream
    → Significant events trigger reflection
    → Create PersonaEntry (CWM-E) linked to event
    → Update EmotionState (confidence, caution)
    → Influences future planner heuristics
```

---

## 5. API & SDK

### Sophia Endpoints

| Endpoint | Purpose |
|----------|---------|
| `GET /state?model_type=cwm-a` | Retrieve current abstract world state |
| `POST /simulate` | Submit state/action to CWM-G for prediction |
| `GET /history?include_emotions=true` | Execution history with CWM-E entries |

### SDK Classes

```python
from logos.cwm import AbstractState, GenerativeState, EmotionalState

# All inherit from base CWMState class
```

---

## 6. Why Unified Envelope Matters

1. **Consistent APIs** – One schema for `/state`, `/plan`, `/simulate` removes bespoke payloads
2. **Traceable diagnostics** – Correlate events by `state_id`/`model_type` across logs and OTel
3. **Storage parity** – Neo4j nodes and Milvus embeddings stay in sync
4. **Future extensibility** – Adding CWM-Future layers (safety, trust) becomes plug-and-play

---

## 7. Implementation Scope

The contract covers:
- **Backend schemas** – Pydantic models, Neo4j/Milvus persistence
- **API contracts** – OpenAPI specs + generated SDKs (TypeScript + Python)
- **Clients** – Apollo CLI + web
- **Observability** – Structured logs, OTel exporters

### Storage Rules

- Persist every record as `(:CWMState {state_id, model_type, ...})` with model-specific label (`:CWM_A_STATE`)
- Attach `(:CWMState)-[:DESCRIBES]->(:Process)` / `(:Entity)` edges using IDs in `links`
- Mirror envelope in Milvus documents for uniform querying

### API/Logging Rules

- `/state` returns `{"states": [<CWMState>], "cursor": ...}`
- Structured logs include `state_id`, `model_type`, `status`
- OTel spans correlate UI views with backend emissions

---

## 8. Success Criteria

- [ ] All `/state`, `/plan`, `/simulate` responses include `states[]`
- [ ] Apollo CLI/web render without custom mappers per model type
- [ ] Structured logs and OTel traces include `state_id`, `model_type`, `status`
- [ ] Neo4j graph contains `(:CWMState)` nodes linked to processes/entities/persona
- [ ] Verification evidence references the new contract

---

## Related Documentation

- [Phase 2 Specification](../architecture/PHASE2_SPEC.md) - Full CWMState contract definition
- [Phase 3 Specification](../architecture/PHASE3_SPEC.md) - Learning & memory extensions
- [SDK Documentation](../sdk/README.md) - Client library usage
