# LOGOS HCG Development Cluster
# See Project LOGOS spec: Section 4.1 (Core Ontology) and Section 5.2 (Vector Store).
# Neo4j (with neosemantics/SHACL support) + Milvus for the Hybrid Causal Graph backend.

services:
  neo4j:
    image: neo4j:5.11.0
    container_name: logos-hcg-neo4j
    ports:
      - "${NEO4J_HTTP_PORT:-7474}:7474"  # HTTP
      - "${NEO4J_BOLT_PORT:-7687}:7687"  # Bolt
    environment:
      - NEO4J_AUTH=neo4j/logosdev
      - NEO4JLABS_PLUGINS=${NEO4JLABS_PLUGINS:-["apoc", "n10s"]}
      - NEO4J_dbms_security_procedures_unrestricted=apoc.*,n10s.*
      - NEO4J_dbms_security_procedures_allowlist=apoc.*,n10s.*
      # Accept license for plugins
      - NEO4J_ACCEPT_LICENSE_AGREEMENT=yes
    volumes:
      - neo4j-data:/data
      - neo4j-logs:/logs
      - neo4j-plugins:/plugins
    networks:
      - logos-hcg-dev-net
    restart: unless-stopped

  milvus-standalone:
    image: milvusdb/milvus:v2.3.3
    container_name: logos-hcg-milvus
    ports:
      - "${MILVUS_PORT:-19530}:19530"  # gRPC
      - "${MILVUS_METRICS_PORT:-9091}:9091"    # Metrics
    environment:
      - ETCD_USE_EMBED=true
      - COMMON_STORAGETYPE=local
    volumes:
      - milvus-data:/var/lib/milvus
    networks:
      - logos-hcg-dev-net
    restart: unless-stopped
    command: ["milvus", "run", "standalone"]

  shacl-validation:
    build:
      context: ..
      dockerfile: infra/Dockerfile.shacl-validation
    container_name: logos-shacl-validation
    ports:
      - "${SHACL_API_PORT:-8081}:8081"  # SHACL Validation API
    volumes:
      - ../ontology:/app/ontology:ro
    networks:
      - logos-hcg-dev-net
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8081/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

networks:
  logos-hcg-dev-net:
    driver: bridge

volumes:
  neo4j-data:
  neo4j-logs:
  neo4j-plugins:
  milvus-data:
