name: Weekly Progress Report

on:
  schedule:
    # Run every Monday at 9:00 AM UTC
    - cron: '0 9 * * 1'
  workflow_dispatch:  # Allow manual triggering

permissions:
  issues: read
  contents: read

jobs:
  generate-report:
    runs-on: ubuntu-latest
    name: Generate Weekly Progress Report
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Generate Weekly Report
        uses: actions/github-script@v7
        with:
          script: |
            const today = new Date().toISOString().split('T')[0];
            const oneWeekAgo = new Date(Date.now() - 7 * 24 * 60 * 60 * 1000).toISOString();
            
            // Fetch issues
            const { data: inProgressIssues } = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'status:in-progress',
              per_page: 100
            });
            
            const { data: blockedIssues } = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'status:blocked',
              per_page: 100
            });
            
            const { data: closedIssues } = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'closed',
              since: oneWeekAgo,
              per_page: 100
            });
            
            const { data: allOpenIssues } = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'phase:1',
              per_page: 100
            });
            
            // Build report
            let report = `# Weekly Progress Report\n\n`;
            report += `**Generated:** ${today}\n`;
            report += `**Phase:** Phase 1 - HCG and Abstract Pipeline\n\n`;
            
            report += `## Summary\n\n`;
            report += `- **Total Open Issues (Phase 1):** ${allOpenIssues.length}\n`;
            report += `- **In Progress:** ${inProgressIssues.length}\n`;
            report += `- **Completed This Week:** ${closedIssues.length}\n`;
            report += `- **Blocked:** ${blockedIssues.length}\n\n`;
            
            // In Progress
            report += `## ðŸš§ In Progress (${inProgressIssues.length})\n\n`;
            if (inProgressIssues.length > 0) {
              for (const issue of inProgressIssues) {
                const assignees = issue.assignees.map(a => `@${a.login}`).join(', ') || 'Unassigned';
                const labels = issue.labels.map(l => l.name).filter(l => l.startsWith('component:') || l.startsWith('workstream:')).join(', ');
                report += `- #${issue.number} - ${issue.title}\n`;
                report += `  - Assignees: ${assignees}\n`;
                report += `  - Labels: ${labels}\n`;
                report += `  - Updated: ${new Date(issue.updated_at).toLocaleDateString()}\n\n`;
              }
            } else {
              report += `No issues currently in progress.\n\n`;
            }
            
            // Completed
            report += `## âœ… Completed This Week (${closedIssues.length})\n\n`;
            if (closedIssues.length > 0) {
              for (const issue of closedIssues) {
                const labels = issue.labels.map(l => l.name).filter(l => l.startsWith('component:') || l.startsWith('workstream:')).join(', ');
                report += `- #${issue.number} - ${issue.title}\n`;
                report += `  - Closed: ${new Date(issue.closed_at).toLocaleDateString()}\n`;
                report += `  - Labels: ${labels}\n\n`;
              }
            } else {
              report += `No issues completed this week.\n\n`;
            }
            
            // Blocked
            report += `## ðŸš« Blocked (${blockedIssues.length})\n\n`;
            if (blockedIssues.length > 0) {
              for (const issue of blockedIssues) {
                const assignees = issue.assignees.map(a => `@${a.login}`).join(', ') || 'Unassigned';
                report += `- #${issue.number} - ${issue.title}\n`;
                report += `  - Assignees: ${assignees}\n`;
                report += `  - Reason: Please check issue comments\n\n`;
              }
            } else {
              report += `No blocked issues.\n\n`;
            }
            
            // Breakdown by component
            report += `## ðŸ“Š Breakdown by Component\n\n`;
            const componentCounts = {};
            for (const issue of allOpenIssues) {
              const componentLabel = issue.labels.find(l => l.name.startsWith('component:'));
              const component = componentLabel ? componentLabel.name : 'untagged';
              componentCounts[component] = (componentCounts[component] || 0) + 1;
            }
            
            for (const [component, count] of Object.entries(componentCounts).sort((a, b) => b[1] - a[1])) {
              report += `- **${component}**: ${count} open issues\n`;
            }
            
            report += `\n---\n\n`;
            report += `*This report is automatically generated every Monday. To view all issues, visit the [Project Board](https://github.com/${context.repo.owner}/${context.repo.repo}/projects) or [Issues page](https://github.com/${context.repo.owner}/${context.repo.repo}/issues).*\n`;
            
            // Output the report
            console.log(report);
            
            // Save as job summary
            await core.summary
              .addRaw(report)
              .write();
            
            // Optionally: Create a discussion post or comment on a tracking issue
            // This requires additional permissions and setup
