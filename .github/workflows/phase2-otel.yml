name: Phase 2 - OTel Observability Smoke Tests

on:
  push:
    branches:
      - main
      - develop
    paths:
      - 'logos_observability/**'
      - 'logos_sophia/**'
      - 'tests/integration/observability/**'
      - 'pyproject.toml'
  pull_request:
    paths:
      - 'logos_observability/**'
      - 'logos_sophia/**'
      - 'tests/integration/observability/**'
      - 'pyproject.toml'
  workflow_dispatch:

permissions:
  contents: read

jobs:
  otel-smoke-test:
    name: OpenTelemetry Smoke Tests
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ['3.10', '3.11', '3.12']
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e .
          pip install pytest pytest-cov httpx
          pip install opentelemetry-exporter-otlp-proto-grpc
      
      - name: Run OTel smoke tests
        run: |
          pytest tests/integration/observability/test_otel_smoke.py -v --cov=logos_observability --cov-report=term-missing
      
      - name: Run observability tests
        run: |
          pytest tests/integration/observability/test_observability.py -v
      
      - name: Upload coverage
        uses: actions/upload-artifact@v4
        if: matrix.python-version == '3.11'
        with:
          name: otel-coverage-report
          path: .coverage
          retention-days: 7

  collector-config-validation:
    name: Validate OTel Collector Config
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Validate YAML files
        run: |
          # Install yq for YAML validation
          sudo wget -qO /usr/local/bin/yq https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64
          sudo chmod +x /usr/local/bin/yq
          
          # Validate config files
          yq eval '.' infra/otel-collector-config.yaml > /dev/null
          yq eval '.' infra/tempo-config.yaml > /dev/null
          yq eval '.' infra/grafana-datasources.yaml > /dev/null
          yq eval '.' infra/grafana-dashboards.yaml > /dev/null
          
          echo "✓ All YAML config files are valid"
      
      - name: Validate Grafana dashboard JSON
        run: |
          # Validate dashboard JSON syntax
          python -m json.tool infra/dashboards/logos-key-signals.json > /dev/null
          echo "✓ Grafana dashboard JSON is valid"
      
      - name: Validate docker-compose
        run: |
          # Install docker-compose
          sudo apt-get update
          sudo apt-get install -y docker-compose
          
          # Validate compose file
          docker-compose -f infra/docker-compose.otel.yml config > /dev/null
          echo "✓ Docker compose file is valid"

  documentation-check:
    name: Check Documentation
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Check required documentation exists
        run: |
          # Verify all required documentation files exist
          test -f infra/OTEL_SETUP.md || (echo "Missing infra/OTEL_SETUP.md" && exit 1)
          test -f logos_observability/README.md || (echo "Missing logos_observability/README.md" && exit 1)
          test -f scripts/demo_capture/README.md || (echo "Missing scripts/demo_capture/README.md" && exit 1)
          
          echo "✓ All required documentation files exist"
      
      - name: Check documentation references
        run: |
          # Verify key terms are documented
          grep -q "OTLP" infra/OTEL_SETUP.md || (echo "OTEL_SETUP.md missing OTLP documentation" && exit 1)
          grep -q "Grafana" infra/OTEL_SETUP.md || (echo "OTEL_SETUP.md missing Grafana documentation" && exit 1)
          grep -q "Tempo" infra/OTEL_SETUP.md || (echo "OTEL_SETUP.md missing Tempo documentation" && exit 1)
          grep -q "plan_id" infra/OTEL_SETUP.md || (echo "OTEL_SETUP.md missing plan_id tracing documentation" && exit 1)
          
          echo "✓ Documentation covers all required topics"
