name: Phase 2 E2E Tests

on:
  pull_request:
    branches: [main]
    paths:
      - 'tests/phase2/**'
      - 'scripts/start_services.sh'
      - '.github/workflows/phase2-e2e.yml'
  push:
    branches: [main]
    paths:
      - 'tests/phase2/**'
      - 'scripts/start_services.sh'
      - '.github/workflows/phase2-e2e.yml'
  workflow_dispatch:

jobs:
  phase2-e2e:
    name: Phase 2 Integration Tests
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    strategy:
      matrix:
        python-version: ['3.11']
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
          cache: 'pip'
      
      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y curl netcat-openbsd
      
      - name: Start infrastructure
        run: |
          cd tests/phase2
          docker compose -f docker-compose.test.yml up -d
          echo "Infrastructure starting..."
      
      - name: Wait for Neo4j
        run: |
          echo "Waiting for Neo4j..."
          for i in {1..60}; do
            if docker exec logos-phase2-neo4j-test cypher-shell -u neo4j -p logosdev "RETURN 1" 2>/dev/null; then
              echo "Neo4j is ready"
              exit 0
            fi
            echo "Waiting... (attempt $i/60)"
            sleep 2
          done
          echo "Neo4j failed to start"
          exit 1
      
      - name: Wait for Milvus
        run: |
          echo "Waiting for Milvus..."
          for i in {1..60}; do
            if curl -f http://localhost:9091/healthz 2>/dev/null; then
              echo "Milvus is ready"
              exit 0
            fi
            echo "Waiting... (attempt $i/60)"
            sleep 2
          done
          echo "Milvus failed to start"
          exit 1
      
      - name: Install Poetry
        run: |
          curl -sSL https://install.python-poetry.org | python3 -
          echo "$HOME/.local/bin" >> $GITHUB_PATH
      
      - name: Install Logos dependencies
        run: |
          poetry install --with dev
      
      - name: Checkout Sophia
        uses: actions/checkout@v4
        with:
          repository: c-daly/sophia
          path: sophia
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Checkout Hermes
        uses: actions/checkout@v4
        with:
          repository: c-daly/hermes
          ref: main
          path: hermes
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Checkout Apollo
        uses: actions/checkout@v4
        with:
          repository: c-daly/apollo
          path: apollo
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Install Apollo SDK
        run: |
          poetry run pip install -e ./apollo
      
      - name: Install Sophia dependencies
        run: |
          cd sophia
          # Install with relaxed constraints since logos already locked versions
          poetry install --no-root
          # Then install sophia package using pip to avoid version conflicts
          poetry run pip install -e .
      
      - name: Install Hermes dependencies
        run: |
          cd hermes
          # Install with relaxed constraints since logos already locked versions
          poetry install --no-root
          # Then install hermes package using pip to avoid version conflicts
          poetry run pip install -e .
      
      - name: Install Apollo dependencies
        run: |
          cd apollo
          # Install with relaxed constraints since logos already locked versions
          poetry install --no-root
          # Then install apollo package using pip to avoid version conflicts
          poetry run pip install -e .
      
      - name: Start services
        run: |
          # Update start_services.sh to use CI repo paths
          sed -i 's|$LOGOS_ROOT/../sophia|$GITHUB_WORKSPACE/sophia|g' scripts/start_services.sh
          sed -i 's|$LOGOS_ROOT/../hermes|$GITHUB_WORKSPACE/hermes|g' scripts/start_services.sh
          sed -i 's|$LOGOS_ROOT/../apollo|$GITHUB_WORKSPACE/apollo|g' scripts/start_services.sh
          
          cd scripts
          chmod +x start_services.sh
          SOPHIA_API_KEY=test-ci-key ./start_services.sh start
          
          # Show service logs for debugging
          echo "=== Service logs ==="
          for log in .pids/*.log; do
            if [ -f "$log" ]; then
              echo "=== $(basename $log) ==="
              tail -50 "$log"
            fi
          done
          
          # Wait for services to be ready
          echo "Waiting for services to start..."
          for i in {1..30}; do
            SOPHIA_OK=$(curl -f http://localhost:8001/health 2>/dev/null && echo "ok" || echo "fail")
            HERMES_OK=$(curl -f http://localhost:8002/health 2>/dev/null && echo "ok" || echo "fail")
            APOLLO_OK=$(curl -f http://localhost:8003/api/hcg/health 2>/dev/null && echo "ok" || echo "fail")
            
            if [ "$SOPHIA_OK" = "ok" ] && [ "$HERMES_OK" = "ok" ] && [ "$APOLLO_OK" = "ok" ]; then
              echo "All services ready!"
              exit 0
            fi
            echo "Waiting... Sophia: $SOPHIA_OK, Hermes: $HERMES_OK, Apollo: $APOLLO_OK (attempt $i/30)"
            sleep 2
          done
          
          # If we get here, services failed - show full logs
          echo "=== FULL SERVICE LOGS ==="
          for log in .pids/*.log; do
            if [ -f "$log" ]; then
              echo "=== $(basename $log) ==="
              cat "$log"
            fi
          done
          
          echo "Services failed to start in time"
          exit 1
        env:
          NEO4J_URI: bolt://localhost:7687
          NEO4J_USER: neo4j
          NEO4J_PASSWORD: logosdev
          MILVUS_HOST: localhost
          MILVUS_PORT: 19530
          SOPHIA_API_KEY: test-ci-key
          HERMES_PORT: 8002
          APOLLO_PORT: 8003
      
      - name: Run Phase 2 E2E Tests
        run: |
          poetry run pytest tests/phase2/test_phase2_end_to_end.py -v --tb=short
        env:
          RUN_P2_E2E: "1"
          SOPHIA_URL: http://localhost:8001
          HERMES_URL: http://localhost:8002
          APOLLO_URL: http://localhost:8003
          NEO4J_URI: bolt://localhost:7687
          NEO4J_USER: neo4j
          NEO4J_PASSWORD: logosdev
          MILVUS_HOST: localhost
          MILVUS_PORT: 19530
          SOPHIA_API_KEY: test-ci-key
      
      - name: Stop services
        if: always()
        run: |
          cd scripts
          ./start_services.sh stop || true
      
      - name: Collect service logs on failure
        if: failure()
        run: |
          echo "=== Service PIDs and status ==="
          cat scripts/.pids/*.pid 2>/dev/null || echo "No PID files found"
          
          echo -e "\n=== Port status ==="
          netstat -tlnp 2>/dev/null | grep -E ':(8001|8002|8003|7687|19530)' || echo "No services listening"
          
          echo -e "\n=== Neo4j logs ==="
          docker logs logos-phase2-neo4j-test --tail=100 || true
          
          echo -e "\n=== Milvus logs ==="
          docker logs logos-phase2-milvus-test --tail=100 || true
      
      - name: Stop test services
        if: always()
        run: |
          cd tests/phase2
          docker compose -f docker-compose.test.yml down -v || true
          docker volume prune -f || true
