name: Create Phase 1 Issues and Project Board

on:
  workflow_dispatch:
    inputs:
      create_milestones:
        description: 'Create milestones first'
        required: false
        default: 'true'
        type: boolean
      create_project:
        description: 'Create project board'
        required: false
        default: 'true'
        type: boolean

jobs:
  create-project-and-issues:
    runs-on: ubuntu-latest
    permissions:
      issues: write
      contents: read
      repository-projects: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'
      
      - name: Sync labels first
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          echo "üè∑Ô∏è  Syncing labels before creating issues..."
          
          # Function to create or update a label
          create_or_update_label() {
            local name="$1"
            local color="$2"
            local description="$3"
            
            # Try to create the label
            gh api repos/${{ github.repository }}/labels -X POST \
              -f name="$name" \
              -f color="$color" \
              -f description="$description" 2>/dev/null || \
            # If creation fails (label exists), update it
            gh api repos/${{ github.repository }}/labels/$name -X PATCH \
              -f color="$color" \
              -f description="$description" 2>/dev/null || \
            echo "‚ö†Ô∏è  Could not sync label: $name"
          }
          
          # Parse YAML and create/update labels
          while IFS= read -r line; do
            if [[ $line =~ ^-\ name:\ \"(.+)\" ]]; then
              name="${BASH_REMATCH[1]}"
            elif [[ $line =~ ^\ \ color:\ \"(.+)\" ]]; then
              color="${BASH_REMATCH[1]}"
            elif [[ $line =~ ^\ \ description:\ \"(.+)\" ]]; then
              description="${BASH_REMATCH[1]}"
              create_or_update_label "$name" "$color" "$description"
            fi
          done < .github/labels.yml
          
          echo "‚úÖ Labels synced successfully"
      
      - name: Create GitHub Project
        if: inputs.create_project == 'true'
        id: create-project
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          echo "Creating GitHub Project board..."
          
          # First, get the owner ID and repository ID
          REPO_INFO=$(gh api graphql -f query='
            query {
              repository(owner: "${{ github.repository_owner }}", name: "${{ github.event.repository.name }}") {
                id
                owner {
                  id
                }
              }
            }')
          
          OWNER_ID=$(echo "$REPO_INFO" | jq -r '.data.repository.owner.id')
          REPO_ID=$(echo "$REPO_INFO" | jq -r '.data.repository.id')
          
          echo "Owner ID: $OWNER_ID"
          echo "Repository ID: $REPO_ID"
          
          # Create project using GraphQL API and capture both id and number
          PROJECT_RESPONSE=$(gh api graphql \
            -f ownerId="$OWNER_ID" \
            -f title="Project LOGOS - Phase 1" \
            -f repositoryId="$REPO_ID" \
            -f query='
            mutation($ownerId: ID!, $title: String!, $repositoryId: ID!) {
              createProjectV2(input: {
                ownerId: $ownerId
                title: $title
                repositoryId: $repositoryId
              }) {
                projectV2 {
                  id
                  number
                }
              }
            }')
          
          PROJECT_ID=$(echo "$PROJECT_RESPONSE" | jq -r '.data.createProjectV2.projectV2.id')
          PROJECT_NUMBER=$(echo "$PROJECT_RESPONSE" | jq -r '.data.createProjectV2.projectV2.number')
          
          echo "project_id=$PROJECT_ID" >> $GITHUB_OUTPUT
          echo "project_number=$PROJECT_NUMBER" >> $GITHUB_OUTPUT
          echo "‚úÖ Project board created with ID: $PROJECT_ID (Project #$PROJECT_NUMBER)"
      
      - name: Create milestones
        if: inputs.create_milestones == 'true'
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          echo "Creating Phase 1 milestones..."
          
          # Function to create milestone if it doesn't exist
          create_milestone_if_not_exists() {
            local title="$1"
            local description="$2"
            
            # Check if milestone already exists
            if gh api repos/${{ github.repository }}/milestones --jq '.[].title' | grep -q "^${title}$"; then
              echo "‚ÑπÔ∏è  Milestone already exists: $title"
            else
              if gh api repos/${{ github.repository }}/milestones -X POST \
                -f title="$title" \
                -f description="$description" 2>&1; then
                echo "‚úÖ Created milestone: $title"
              else
                echo "‚ùå Failed to create milestone: $title"
              fi
            fi
          }
          
          # M1: Infrastructure & Knowledge Foundation
          create_milestone_if_not_exists \
            "M1: HCG Store & Retrieve" \
            "Knowledge graph operational. Neo4j + Milvus working, core ontology loaded, basic CRUD operations functional."
          
          # M2: Language & Perception Services  
          create_milestone_if_not_exists \
            "M2: SHACL Validation" \
            "Validation and language services operational. SHACL validation working, Hermes endpoints functional, embeddings integrated."
          
          # M3: Cognitive Core & Reasoning
          create_milestone_if_not_exists \
            "M3: Simple Planning" \
            "Cognitive capabilities demonstrated. Sophia can generate valid plans using causal reasoning over the knowledge graph."
          
          # M4: Integration & Demonstration
          create_milestone_if_not_exists \
            "M4: Pick and Place" \
            "End-to-end autonomous behavior. Full pipeline working from user command to execution with knowledge graph updates."
          
          echo "‚úÖ Milestones ready"
      
      - name: Generate issue creation script
        run: |
          python3 .github/scripts/create_issues_by_epoch.py --format gh-cli > /tmp/create_issues.sh
          chmod +x /tmp/create_issues.sh
          echo "‚úÖ Generated issue creation script"
      
      - name: Create issues
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          echo "Creating 65 Phase 1 issues organized by functional epochs..."
          bash /tmp/create_issues.sh
          echo "‚úÖ Issues created"
      
      - name: Add issues to project
        if: inputs.create_project == 'true'
        env:
          GH_TOKEN: ${{ github.token }}
          PROJECT_ID: ${{ steps.create-project.outputs.project_id }}
        run: |
          echo "Adding issues to project board..."
          
          # Get all Phase 1 issues
          ISSUE_IDS=$(gh api graphql -f query='
            query {
              repository(owner: "${{ github.repository_owner }}", name: "${{ github.event.repository.name }}") {
                issues(first: 100, labels: ["phase:1"], states: OPEN) {
                  nodes {
                    id
                  }
                }
              }
            }' --jq '.data.repository.issues.nodes[].id')
          
          # Add each issue to the project
          for ISSUE_ID in $ISSUE_IDS; do
            gh api graphql -f query='
              mutation {
                addProjectV2ItemById(input: {
                  projectId: "'"$PROJECT_ID"'"
                  contentId: "'"$ISSUE_ID"'"
                }) {
                  item {
                    id
                  }
                }
              }' > /dev/null 2>&1 || echo "Issue already in project or error"
          done
          
          echo "‚úÖ Issues added to project board"
      
      - name: Summary
        run: |
          echo "## Phase 1 Setup Complete ‚úÖ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Created:" >> $GITHUB_STEP_SUMMARY
          echo "- ‚úÖ 4 Milestones (M1, M2, M3, M4)" >> $GITHUB_STEP_SUMMARY
          echo "- ‚úÖ 65 Issues organized by functional epochs" >> $GITHUB_STEP_SUMMARY
          echo "- ‚úÖ GitHub Project board" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Functional Epochs:" >> $GITHUB_STEP_SUMMARY
          echo "- **Epoch 1:** Infrastructure & Knowledge Foundation (41 issues)" >> $GITHUB_STEP_SUMMARY
          echo "- **Epoch 2:** Language & Perception Services (5 issues)" >> $GITHUB_STEP_SUMMARY
          echo "- **Epoch 3:** Cognitive Core & Reasoning (13 issues)" >> $GITHUB_STEP_SUMMARY
          echo "- **Epoch 4:** Integration & Demonstration (6 issues)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Quick Links:" >> $GITHUB_STEP_SUMMARY
          echo "- [View Issues](https://github.com/${{ github.repository }}/issues?q=is%3Aissue+is%3Aopen+label%3Aphase%3A1)" >> $GITHUB_STEP_SUMMARY
          echo "- [View Milestones](https://github.com/${{ github.repository }}/milestones)" >> $GITHUB_STEP_SUMMARY
          echo "- [View Project Board](https://github.com/${{ github.repository }}/projects)" >> $GITHUB_STEP_SUMMARY
