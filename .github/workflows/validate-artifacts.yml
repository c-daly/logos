name: Validate LOGOS Artifacts

on:
  push:
    branches:
      - main
      - develop
    paths:
      - 'ontology/**'
      - 'contracts/**'
      - '.github/workflows/validate-artifacts.yml'
  pull_request:
    paths:
      - 'ontology/**'
      - 'contracts/**'
      - '.github/workflows/validate-artifacts.yml'
  workflow_dispatch:

permissions:
  contents: read

jobs:
  validate-cypher:
    name: Validate Cypher Ontology
    runs-on: ubuntu-latest
    permissions:
      contents: read
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Set up Neo4j for syntax validation
        run: |
          docker run -d --name neo4j-validator \
            -p 7474:7474 -p 7687:7687 \
            -e NEO4J_AUTH=neo4j/testpassword \
            -e NEO4J_PLUGINS='["apoc", "n10s"]' \
            neo4j:5.13.0
          
          echo "Waiting for Neo4j to start..."
          timeout 60 bash -c 'until docker exec neo4j-validator cypher-shell -u neo4j -p testpassword "RETURN 1;" 2>/dev/null; do sleep 2; done'
          echo "Neo4j is ready"
      
      - name: Validate core_ontology.cypher syntax
        run: |
          echo "Validating Cypher syntax for core_ontology.cypher..."
          
          # Execute the Cypher script to validate syntax
          docker exec neo4j-validator cypher-shell -u neo4j -p testpassword \
            -f /dev/stdin < ontology/core_ontology.cypher
          
          echo "✅ Cypher syntax validation passed"
      
      - name: Cleanup
        if: always()
        run: |
          docker stop neo4j-validator || true
          docker rm neo4j-validator || true

  validate-shacl:
    name: Validate SHACL Shapes
    runs-on: ubuntu-latest
    permissions:
      contents: read
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install RDF validation tools
        run: |
          pip install rdflib pyshacl
      
      - name: Validate shacl_shapes.ttl syntax
        run: |
          python3 << 'EOF'
          from rdflib import Graph
          from rdflib.plugins.parsers.notation3 import BadSyntax
          import sys
          
          print("Validating RDF/Turtle syntax for shacl_shapes.ttl...")
          
          try:
              g = Graph()
              g.parse("ontology/shacl_shapes.ttl", format="turtle")
              print(f"✅ SHACL shapes validation passed")
              print(f"   Loaded {len(g)} triples")
              
              # Verify it contains SHACL shapes
              from rdflib.namespace import SH
              shapes = list(g.subjects(predicate=None, object=SH.NodeShape))
              print(f"   Found {len(shapes)} SHACL NodeShapes")
              
              if len(shapes) == 0:
                  print("⚠️  Warning: No SHACL NodeShapes found")
              
          except BadSyntax as e:
              print(f"❌ Turtle syntax error: {e}")
              sys.exit(1)
          except Exception as e:
              print(f"❌ Validation error: {e}")
              sys.exit(1)
          EOF

  validate-openapi:
    name: Validate OpenAPI Contract
    runs-on: ubuntu-latest
    permissions:
      contents: read
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Install OpenAPI validation tools
        run: |
          npm install -g @apidevtools/swagger-cli
      
      - name: Validate hermes.openapi.yaml
        run: |
          echo "Validating OpenAPI 3.1.0 specification for hermes.openapi.yaml..."
          
          swagger-cli validate contracts/hermes.openapi.yaml
          
          echo "✅ OpenAPI validation passed"
      
      - name: Bundle OpenAPI specification
        run: |
          echo "Bundling OpenAPI specification..."
          swagger-cli bundle contracts/hermes.openapi.yaml --outfile /tmp/hermes.bundled.yaml --type yaml
          echo "✅ OpenAPI bundle created successfully"

  summary:
    name: Validation Summary
    runs-on: ubuntu-latest
    needs: [validate-cypher, validate-shacl, validate-openapi]
    if: always()
    permissions:
      contents: read
    
    steps:
      - name: Check validation results
        run: |
          if [ "${{ needs.validate-cypher.result }}" != "success" ]; then
            echo "❌ Cypher validation failed"
            exit 1
          fi
          
          if [ "${{ needs.validate-shacl.result }}" != "success" ]; then
            echo "❌ SHACL validation failed"
            exit 1
          fi
          
          if [ "${{ needs.validate-openapi.result }}" != "success" ]; then
            echo "❌ OpenAPI validation failed"
            exit 1
          fi
          
          echo "## ✅ All Validations Passed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Validated Artifacts:" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ Cypher Ontology (ontology/core_ontology.cypher)" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ SHACL Shapes (ontology/shacl_shapes.ttl)" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ OpenAPI Contract (contracts/hermes.openapi.yaml)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "All canonical LOGOS artifacts are syntactically valid." >> $GITHUB_STEP_SUMMARY
